# ğŸš€ AIæ™ºèƒ½é¢˜åº“ç³»ç»Ÿ - åç«¯å®Œæ•´å¼€å‘æŒ‡å—

> **ç‰ˆæœ¬ï¼š** V2.0  
> **æ›´æ–°æ—¥æœŸï¼š** 2025-10-14  
> **æŠ€æœ¯æ ˆï¼š** NestJS 10 + TypeScript + PostgreSQL + gRPC + å¾®æœåŠ¡

---

## ğŸ“– ä½¿ç”¨æœ¬æ–‡æ¡£

**æœ¬æ–‡æ¡£æ˜¯ç²¾ç®€çš„å¼€å‘æŒ‡å—ï¼Œå¦‚éœ€è¯¦ç»†ä¿¡æ¯è¯·æŸ¥çœ‹ï¼š**
- [å®Œæ•´æ¶æ„è®¾è®¡](./åç«¯æ–‡æ¡£/ARCHITECTURE.md) - è¯¦ç»†çš„ç³»ç»Ÿæ¶æ„
- [æ¶æ„å›¾é›†](./åç«¯æ–‡æ¡£/ARCHITECTURE_DIAGRAMS.md) - Mermaidå¯è§†åŒ–å›¾
- [ç›‘æ§ç³»ç»ŸæŒ‡å—](./åç«¯æ–‡æ¡£/MONITORING_GUIDE.md) - Prometheus + Grafana + ELK
- [å®Œæ•´å¼€å‘æ‰‹å†Œ](./åç«¯æ–‡æ¡£/COMPLETE_GUIDE.md) - 1887è¡Œè¯¦ç»†è§„èŒƒ
- [å¾®æœåŠ¡åˆ—è¡¨](./åç«¯æ–‡æ¡£/MICROSERVICES.md) - 9ä¸ªå¾®æœåŠ¡è¯´æ˜

---

## ğŸ“‘ ç›®å½•

1. [å¿«é€Ÿå¼€å§‹](#1-å¿«é€Ÿå¼€å§‹-5åˆ†é’Ÿ)
2. [é¡¹ç›®ç»“æ„](#2-é¡¹ç›®ç»“æ„)
3. [æ ¸å¿ƒæ¦‚å¿µ](#3-æ ¸å¿ƒæ¦‚å¿µ)
4. [å¾®æœåŠ¡æ¶æ„](#4-å¾®æœåŠ¡æ¶æ„)
5. [æ•°æ®åº“è®¾è®¡](#5-æ•°æ®åº“è®¾è®¡)
6. [APIå¼€å‘](#6-apiå¼€å‘)
7. [ç›‘æ§ç³»ç»Ÿ](#7-ç›‘æ§ç³»ç»Ÿ)
8. [éƒ¨ç½²æŒ‡å—](#8-éƒ¨ç½²æŒ‡å—)
9. [å¼€å‘è§„èŒƒ](#9-å¼€å‘è§„èŒƒ)
10. [å¸¸è§é—®é¢˜](#10-å¸¸è§é—®é¢˜)

---

## 1. å¿«é€Ÿå¼€å§‹ (5åˆ†é’Ÿ)

### 1.1 ç¯å¢ƒè¦æ±‚

```bash
Node.js >= 20.x
PostgreSQL >= 16.x
Redis >= 7.x
Docker & Docker Compose (æ¨è)
```

### 1.2 ä¸€é”®å¯åŠ¨

```bash
# 1. å…‹éš†é¡¹ç›®
git clone <repository-url>
cd quizmind/packages/server

# 2. å®‰è£…ä¾èµ–
npm install

# 3. é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶ï¼Œé…ç½®æ•°æ®åº“ç­‰

# 4. åˆå§‹åŒ–æ•°æ®åº“
npx prisma generate
npx prisma db push
npx ts-node prisma/seed-enterprise.ts

# 5. å¯åŠ¨ç›‘æ§æ ˆï¼ˆå¯é€‰ä½†æ¨èï¼‰
chmod +x scripts/*.sh
./scripts/start-monitoring.sh

# 6. å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run start:dev
```

### 1.3 éªŒè¯å®‰è£…

```bash
# è®¿é—®API
curl http://localhost:3000

# è®¿é—®Swaggeræ–‡æ¡£
open http://localhost:3000/api/docs

# è®¿é—®å¥åº·æ£€æŸ¥
curl http://localhost:3000/health

# è®¿é—®PrometheusæŒ‡æ ‡
curl http://localhost:3000/metrics

# è®¿é—®ç›‘æ§é¢æ¿
open http://localhost:3001    # Grafana (admin/admin)
open http://localhost:9090    # Prometheus
open http://localhost:16686   # Jaeger
open http://localhost:5601    # Kibana
```

---

## 2. é¡¹ç›®ç»“æ„

```
packages/server/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ core/                      # æ ¸å¿ƒæ¡†æ¶
â”‚   â”‚   â”œâ”€â”€ config/               # é…ç½®ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ database/             # æ•°æ®åº“è¿æ¥
â”‚   â”‚   â”œâ”€â”€ logging/              # æ—¥å¿—ç³»ç»Ÿ
â”‚   â”‚   â””â”€â”€ trpc/                 # tRPCé…ç½®
â”‚   â”‚
â”‚   â”œâ”€â”€ infrastructure/           # åŸºç¡€è®¾æ–½
â”‚   â”‚   â”œâ”€â”€ prisma/              # PrismaæœåŠ¡
â”‚   â”‚   â”œâ”€â”€ health/              # å¥åº·æ£€æŸ¥
â”‚   â”‚   â””â”€â”€ metrics/             # æŒ‡æ ‡æ”¶é›†
â”‚   â”‚
â”‚   â”œâ”€â”€ features/                 # ä¸šåŠ¡åŠŸèƒ½
â”‚   â”‚   â”œâ”€â”€ auth/                # è®¤è¯æˆæƒ
â”‚   â”‚   â””â”€â”€ users/               # ç”¨æˆ·ç®¡ç†
â”‚   â”‚
â”‚   â”œâ”€â”€ enterprise/              # ä¼ä¸šåŠŸèƒ½
â”‚   â”‚   â”œâ”€â”€ audit/              # å®¡è®¡æ—¥å¿—
â”‚   â”‚   â”œâ”€â”€ permissions/        # æƒé™ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ email/              # é‚®ä»¶æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ upload/             # æ–‡ä»¶ä¸Šä¼ 
â”‚   â”‚   â””â”€â”€ queue/              # æ¶ˆæ¯é˜Ÿåˆ—
â”‚   â”‚
â”‚   â”œâ”€â”€ microservices/          # å¾®æœåŠ¡ â­
â”‚   â”‚   â”œâ”€â”€ user-service/       # (50051) ç”¨æˆ·æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ exam-service/       # (50052) è€ƒè¯•æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ question-service/   # (50053) é¢˜ç›®æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ paper-service/      # (50054) ç»„å·æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ ai-service/         # (50055) AIæœåŠ¡
â”‚   â”‚   â”œâ”€â”€ practice-service/   # (50056) ç»ƒä¹ æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ analytics-service/  # (50057) åˆ†ææœåŠ¡
â”‚   â”‚   â”œâ”€â”€ social-service/     # (50058) ç¤¾äº¤æœåŠ¡
â”‚   â”‚   â””â”€â”€ document-service/   # (50059) æ–‡æ¡£æœåŠ¡
â”‚   â”‚
â”‚   â”œâ”€â”€ common/                  # å…¬å…±ç»„ä»¶ â­
â”‚   â”‚   â”œâ”€â”€ monitoring/         # Prometheusç›‘æ§
â”‚   â”‚   â”œâ”€â”€ logging/            # Elasticsearchæ—¥å¿—
â”‚   â”‚   â”œâ”€â”€ tracing/            # Jaegerè¿½è¸ª
â”‚   â”‚   â”œâ”€â”€ config/             # é…ç½®ä¸­å¿ƒ
â”‚   â”‚   â”œâ”€â”€ rate-limit/         # é™æµ
â”‚   â”‚   â”œâ”€â”€ load-balancer/      # è´Ÿè½½å‡è¡¡
â”‚   â”‚   â”œâ”€â”€ microservices/      # å¾®æœåŠ¡å·¥å…·
â”‚   â”‚   â””â”€â”€ interceptors/       # æ‹¦æˆªå™¨
â”‚   â”‚
â”‚   â”œâ”€â”€ presentation/            # è¡¨ç°å±‚
â”‚   â”‚   â””â”€â”€ routers/            # tRPCè·¯ç”±
â”‚   â”‚
â”‚   â”œâ”€â”€ shared/                  # å…±äº«å±‚
â”‚   â”‚   â”œâ”€â”€ decorators/         # è£…é¥°å™¨
â”‚   â”‚   â”œâ”€â”€ guards/             # å®ˆå«
â”‚   â”‚   â””â”€â”€ services/           # å…±äº«æœåŠ¡
â”‚   â”‚
â”‚   â””â”€â”€ main.ts                  # åº”ç”¨å…¥å£
â”‚
â”œâ”€â”€ proto/                       # gRPC Protoæ–‡ä»¶
â”‚   â”œâ”€â”€ user.proto
â”‚   â”œâ”€â”€ exam.proto
â”‚   â””â”€â”€ ... (9ä¸ªprotoæ–‡ä»¶)
â”‚
â”œâ”€â”€ prisma/                      # æ•°æ®åº“
â”‚   â”œâ”€â”€ schema.prisma           # Schemaå®šä¹‰
â”‚   â”œâ”€â”€ seed.ts                 # ç§å­æ•°æ®
â”‚   â””â”€â”€ migrations/             # è¿ç§»æ–‡ä»¶
â”‚
â”œâ”€â”€ scripts/                     # è„šæœ¬
â”‚   â”œâ”€â”€ start-monitoring.sh     # å¯åŠ¨ç›‘æ§
â”‚   â””â”€â”€ stop-monitoring.sh      # åœæ­¢ç›‘æ§
â”‚
â”œâ”€â”€ docker-compose.monitoring.yml  # ç›‘æ§æ ˆé…ç½®
â”œâ”€â”€ prometheus.yml              # Prometheusé…ç½®
â””â”€â”€ package.json
```

---

## 3. æ ¸å¿ƒæ¦‚å¿µ

### 3.1 æŠ€æœ¯æ ˆ

```typescript
{
  "æ ¸å¿ƒæ¡†æ¶": "NestJS 10 + TypeScript 5",
  "æ•°æ®åº“": "PostgreSQL 16 + Prisma ORM",
  "ç¼“å­˜": "Redis 7",
  "å¾®æœåŠ¡é€šä¿¡": "gRPC + Protocol Buffers",
  "ç«¯åˆ°ç«¯ç±»å‹å®‰å…¨": "tRPC",
  "æœåŠ¡æ²»ç†": "Consul + Opossum",
  "ç›‘æ§": "Prometheus + Grafana",
  "æ—¥å¿—": "ELK Stack",
  "è¿½è¸ª": "Jaeger + OpenTelemetry",
  "AI": "DeepSeek + LangChain + Pinecone"
}
```

### 3.2 Spring Booté£æ ¼è£…é¥°å™¨

NestJSåŸç”Ÿæ”¯æŒè£…é¥°å™¨ï¼Œæˆ‘ä»¬æ‰©å±•äº†ç±»ä¼¼Spring Bootçš„æ³¨è§£ï¼š

```typescript
// ===== ç¼“å­˜ =====
@Cacheable({ key: 'user', ttl: 300 })
async findUserById(id: string) {
  return this.prisma.user.findUnique({ where: { id } });
}

// ===== äº‹åŠ¡ =====
@Transactional()
async transferPoints(fromId: string, toId: string, points: number) {
  await this.deductPoints(fromId, points);
  await this.addPoints(toId, points);
}

// ===== é‡è¯• =====
@Retry({ maxAttempts: 3, delay: 1000 })
async callExternalAPI() {
  return axios.get('https://api.example.com');
}

// ===== å®šæ—¶ä»»åŠ¡ =====
@Scheduled({ cron: '0 0 2 * * *' })
async dailyCleanup() {
  await this.cleanupOldData();
}

// ===== é™æµ =====
@RateLimit({ max: 100, windowMs: 60000 })
@Get('api/search')
async search() {
  return this.searchService.search();
}

// ===== ç†”æ–­å™¨ =====
@CircuitBreaker({ threshold: 5, timeout: 3000 })
async callUnstableService() {
  return this.externalService.call();
}

// ===== æƒé™æ§åˆ¶ =====
@RequirePermissions('user:read')
@Get('users')
async findAll() {
  return this.userService.findAll();
}

// ===== å®¡è®¡æ—¥å¿— =====
@Audit({ action: 'CREATE', resource: 'USER' })
@Post('users')
async create(@Body() dto: CreateUserDto) {
  return this.userService.create(dto);
}
```

### 3.3 æ¨¡å—åˆ†ç±»

```
infrastructure/    # åŸºç¡€è®¾æ–½ï¼ˆä¸ä¸šåŠ¡æ— å…³ï¼‰
  â”œâ”€ prisma       # æ•°æ®åº“æœåŠ¡
  â”œâ”€ health       # å¥åº·æ£€æŸ¥
  â”œâ”€ metrics      # æŒ‡æ ‡æ”¶é›†
  â””â”€ trpc         # tRPCåŸºç¡€

features/         # ä¸šåŠ¡åŠŸèƒ½ï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰
  â”œâ”€ auth         # è®¤è¯æˆæƒ
  â”œâ”€ users        # ç”¨æˆ·ç®¡ç†
  â”œâ”€ exams        # è€ƒè¯•ç®¡ç†
  â””â”€ questions    # é¢˜ç›®ç®¡ç†

enterprise/       # ä¼ä¸šåŠŸèƒ½ï¼ˆå¢å¼ºåŠŸèƒ½ï¼‰
  â”œâ”€ audit        # å®¡è®¡æ—¥å¿—
  â”œâ”€ permissions  # æƒé™ç®¡ç†
  â”œâ”€ email        # é‚®ä»¶æœåŠ¡
  â”œâ”€ upload       # æ–‡ä»¶ä¸Šä¼ 
  â””â”€ queue        # æ¶ˆæ¯é˜Ÿåˆ—
```

---

## 4. å¾®æœåŠ¡æ¶æ„

### 4.1 æœåŠ¡åˆ—è¡¨

| æœåŠ¡ | ç«¯å£ | èŒè´£ | æŠ€æœ¯ |
|------|------|------|------|
| **API Gateway** | 3000 | ç»Ÿä¸€å…¥å£ã€è·¯ç”± | NestJS + tRPC |
| **User Service** | 50051 | ç”¨æˆ·ã€è®¤è¯ã€RBAC | gRPC + Prisma |
| **Exam Service** | 50052 | è€ƒè¯•ã€ç›‘è€ƒ | gRPC + Prisma |
| **Question Service** | 50053 | é¢˜åº“ã€åˆ†ç±» | gRPC + Prisma |
| **Paper Service** | 50054 | ç»„å·ã€æ™ºèƒ½ç»„å· | gRPC + Prisma |
| **AI Service** | 50055 | AIæ‰¹æ”¹ã€å‡ºé¢˜ | gRPC + DeepSeek |
| **Practice Service** | 50056 | ç»ƒä¹ ã€é”™é¢˜æœ¬ | gRPC + Prisma |
| **Analytics Service** | 50057 | æ•°æ®åˆ†æ | gRPC + Prisma |
| **Social Service** | 50058 | æ’è¡Œæ¦œã€PKã€è®¨è®º | gRPC + Prisma |
| **Document Service** | 50059 | æ–‡æ¡£è§£æã€OCR | gRPC + Tesseract |

### 4.2 åˆ›å»ºå¾®æœåŠ¡

#### æ­¥éª¤1ï¼šå®šä¹‰Protoæ–‡ä»¶

```protobuf
// proto/myservice.proto
syntax = "proto3";
package myservice;

service MyService {
  rpc DoSomething(Request) returns (Response);
}

message Request {
  string id = 1;
}

message Response {
  string result = 1;
}
```

#### æ­¥éª¤2ï¼šåˆ›å»ºæœåŠ¡ç›®å½•

```
src/microservices/myservice/
â”œâ”€â”€ myservice-grpc.controller.ts
â”œâ”€â”€ myservice.service.ts
â”œâ”€â”€ myservice.module.ts
â””â”€â”€ main.ts
```

#### æ­¥éª¤3ï¼šå®ç°Controller

```typescript
// myservice-grpc.controller.ts
import { Controller } from '@nestjs/common';
import { GrpcMethod } from '@nestjs/microservices';

@Controller()
export class MyServiceGrpcController {
  constructor(private readonly service: MyService) {}
  
  @GrpcMethod('MyService', 'DoSomething')
  async doSomething(data: { id: string }) {
    return await this.service.doSomething(data.id);
  }
}
```

#### æ­¥éª¤4ï¼šå¯åŠ¨æœåŠ¡

```typescript
// main.ts
import { NestFactory } from '@nestjs/core';
import { Transport } from '@nestjs/microservices';
import { MyServiceModule } from './myservice.module';
import { join } from 'path';

async function bootstrap() {
  const app = await NestFactory.createMicroservice(MyServiceModule, {
    transport: Transport.GRPC,
    options: {
      package: 'myservice',
      protoPath: join(__dirname, '../../../proto/myservice.proto'),
      url: '0.0.0.0:50060',
    },
  });
  
  await app.listen();
}
bootstrap();
```

### 4.3 æœåŠ¡é—´è°ƒç”¨

```typescript
// åœ¨API Gatewayä¸­è°ƒç”¨å¾®æœåŠ¡
@Injectable()
export class GatewayService {
  private userService: UserServiceClient;
  
  constructor() {
    this.userService = ClientProxyFactory.create({
      transport: Transport.GRPC,
      options: {
        package: 'user',
        protoPath: join(__dirname, '../../proto/user.proto'),
        url: 'localhost:50051',
      },
    });
  }
  
  async getUserById(id: string) {
    return this.userService.send('FindUserById', { id }).toPromise();
  }
}
```

### 4.4 æœåŠ¡æ²»ç†

#### æœåŠ¡æ³¨å†Œï¼ˆConsulï¼‰

```typescript
// common/microservices/service-registry.service.ts
@Injectable()
export class ServiceRegistryService {
  async register(serviceName: string, port: number) {
    await this.consul.agent.service.register({
      id: `${serviceName}-${port}`,
      name: serviceName,
      address: '127.0.0.1',
      port,
      check: {
        http: `http://127.0.0.1:${port}/health`,
        interval: '10s',
      },
    });
  }
}
```

#### è´Ÿè½½å‡è¡¡

```typescript
// common/load-balancer/load-balancer.service.ts
@Injectable()
export class LoadBalancerService {
  // 6ç§ç®—æ³•
  selectInstance(
    serviceName: string,
    instances: ServiceInstance[],
    strategy: LoadBalanceStrategy,
  ) {
    switch (strategy) {
      case 'RANDOM': return this.selectRandom(instances);
      case 'ROUND_ROBIN': return this.selectRoundRobin(instances);
      case 'WEIGHTED_ROUND_ROBIN': return this.selectWeightedRoundRobin(instances);
      case 'LEAST_CONNECTIONS': return this.selectLeastConnections(instances);
      case 'CONSISTENT_HASH': return this.selectConsistentHash(key, instances);
      case 'IP_HASH': return this.selectIPHash(ip, instances);
    }
  }
}
```

#### ç†”æ–­å™¨ï¼ˆOpossumï¼‰

```typescript
// common/microservices/circuit-breaker.service.ts
@Injectable()
export class CircuitBreakerService {
  getBreaker(serviceName: string): CircuitBreaker {
    return new CircuitBreaker(
      async (...args) => this.call(serviceName, ...args),
      {
        timeout: 3000,
        errorThresholdPercentage: 50,
        resetTimeout: 30000,
      }
    );
  }
}
```

---

## 5. æ•°æ®åº“è®¾è®¡

### 5.1 æ ¸å¿ƒåŸåˆ™

**éµå¾ªé˜¿é‡Œå¼€å‘è§„èŒƒ - ä¸ä½¿ç”¨ç‰©ç†å¤–é”®**

```prisma
// âœ… æ­£ç¡®çš„è®¾è®¡
model ExamRecord {
  id       String @id @default(cuid())
  userId   String  // é€»è¾‘å¤–é”®
  examId   String  // é€»è¾‘å¤–é”®
  score    Float
  
  // ä¸å®šä¹‰ @relation
  
  @@index([userId])
  @@index([examId])
  @@map("exam_records")
}
```

### 5.2 åº”ç”¨å±‚éªŒè¯

```typescript
// Serviceå±‚éªŒè¯
async create(dto: CreateExamRecordDto) {
  // éªŒè¯å¹¶è·å–ç”¨æˆ·
  const user = await this.validateAndGetUser(dto.userId);
  
  // éªŒè¯å¹¶è·å–è€ƒè¯•
  const exam = await this.validateAndGetExam(dto.examId);
  
  // ä¸šåŠ¡éªŒè¯
  if (!user.isActive) {
    throw new BadRequestException('ç”¨æˆ·è´¦å·æœªæ¿€æ´»');
  }
  
  return this.prisma.examRecord.create({ data: dto });
}
```

### 5.3 å¸¸ç”¨æ“ä½œ

```typescript
// æŸ¥è¯¢
const user = await this.prisma.user.findUnique({
  where: { id },
  select: { id: true, username: true, email: true },
});

// åˆ›å»º
const user = await this.prisma.user.create({
  data: { username, email, password },
});

// æ›´æ–°
const user = await this.prisma.user.update({
  where: { id },
  data: { username },
});

// åˆ é™¤ï¼ˆè½¯åˆ é™¤ï¼‰
const user = await this.prisma.user.update({
  where: { id },
  data: {
    isActive: false,
    deletedAt: new Date(),
  },
});

// åˆ†é¡µæŸ¥è¯¢
const [users, total] = await Promise.all([
  this.prisma.user.findMany({
    skip: (page - 1) * limit,
    take: limit,
  }),
  this.prisma.user.count(),
]);
```

---

## 6. APIå¼€å‘

### 6.1 tRPCè·¯ç”±

```typescript
// presentation/routers/users.router.ts
import { router, publicProcedure, protectedProcedure } from '../trpc';
import { z } from 'zod';

export const usersRouter = router({
  // å…¬å¼€æ¥å£
  list: publicProcedure
    .input(z.object({
      page: z.number().default(1),
      limit: z.number().default(10),
    }))
    .query(async ({ input }) => {
      return await usersService.findAll(input);
    }),
  
  // éœ€è¦è®¤è¯çš„æ¥å£
  me: protectedProcedure
    .query(async ({ ctx }) => {
      return await usersService.findById(ctx.user.id);
    }),
  
  // éœ€è¦æƒé™çš„æ¥å£
  create: protectedProcedure
    .input(z.object({
      username: z.string().min(3),
      email: z.string().email(),
      password: z.string().min(6),
    }))
    .mutation(async ({ input, ctx }) => {
      // æ£€æŸ¥æƒé™
      if (!ctx.user.permissions.includes('user:create')) {
        throw new Error('æ— æƒé™');
      }
      
      return await usersService.create(input);
    }),
});
```

### 6.2 REST APIï¼ˆSwaggerï¼‰

```typescript
// Controllerç¤ºä¾‹
@Controller('users')
@ApiTags('ç”¨æˆ·ç®¡ç†')
@UseGuards(JwtAuthGuard, PermissionsGuard)
export class UsersController {
  @Get()
  @ApiOperation({ summary: 'è·å–ç”¨æˆ·åˆ—è¡¨' })
  @ApiResponse({ status: 200, description: 'æˆåŠŸ' })
  @RequirePermissions('user:read')
  async findAll(@Query() query: FindUsersDto) {
    return this.usersService.findAll(query);
  }
  
  @Post()
  @ApiOperation({ summary: 'åˆ›å»ºç”¨æˆ·' })
  @RequirePermissions('user:create')
  @Audit({ action: 'CREATE', resource: 'USER' })
  async create(@Body() dto: CreateUserDto) {
    return this.usersService.create(dto);
  }
}
```

### 6.3 DTOéªŒè¯

```typescript
// dtos/create-user.dto.ts
import { IsString, IsEmail, MinLength, IsOptional } from 'class-validator';

export class CreateUserDto {
  @IsString()
  @MinLength(3)
  username: string;
  
  @IsEmail()
  email: string;
  
  @IsString()
  @MinLength(6)
  password: string;
  
  @IsOptional()
  @IsString()
  nickname?: string;
}
```

---

## 7. ç›‘æ§ç³»ç»Ÿ

### 7.1 å¿«é€Ÿå¯åŠ¨

```bash
# å¯åŠ¨æ‰€æœ‰ç›‘æ§æœåŠ¡
./scripts/start-monitoring.sh

# è®¿é—®ç›‘æ§é¢æ¿
open http://localhost:3001    # Grafana
open http://localhost:9090    # Prometheus
open http://localhost:16686   # Jaeger
open http://localhost:5601    # Kibana
```

### 7.2 PrometheusæŒ‡æ ‡

```typescript
// è‡ªåŠ¨æ”¶é›†æŒ‡æ ‡ï¼ˆä½¿ç”¨æ‹¦æˆªå™¨ï¼‰
@Module({
  providers: [
    {
      provide: APP_INTERCEPTOR,
      useClass: MetricsInterceptor,  // è‡ªåŠ¨æ”¶é›†HTTPæŒ‡æ ‡
    },
  ],
})

// æ‰‹åŠ¨è®°å½•æŒ‡æ ‡
this.metricsService.recordHttpRequest(method, path, statusCode, duration);
this.metricsService.recordGrpcCall(service, method, status, duration);
this.metricsService.recordDbQuery(operation, duration);
```

### 7.3 å¸¸ç”¨æŸ¥è¯¢

```promql
# è¯·æ±‚QPS
rate(http_requests_total[1m])

# 95åˆ†ä½å“åº”æ—¶é—´
histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))

# é”™è¯¯ç‡
rate(http_requests_total{status_code=~"5.."}[5m]) / rate(http_requests_total[5m])

# CPUä½¿ç”¨ç‡
100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)
```

### 7.4 æ—¥å¿—æŸ¥è¯¢ï¼ˆKibanaï¼‰

```
# æŸ¥è¯¢é”™è¯¯æ—¥å¿—
level: "ERROR" AND service: "user-service"

# æŸ¥è¯¢ç‰¹å®šTraceId
traceId: "abc123def456"

# æŸ¥è¯¢AIæœåŠ¡è°ƒç”¨
type: "ai_request" AND provider: "deepseek"
```

---

## 8. éƒ¨ç½²æŒ‡å—

### 8.1 Docker Compose

```bash
# å¯åŠ¨ç›‘æ§æ ˆ
docker-compose -f docker-compose.monitoring.yml up -d

# å¯åŠ¨åº”ç”¨
docker-compose up -d

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f
```

### 8.2 Kubernetes

```bash
# éƒ¨ç½²åˆ°K8s
kubectl apply -f k8s/

# æŸ¥çœ‹Pod
kubectl get pods -n ai-quiz-system

# æŸ¥çœ‹æ—¥å¿—
kubectl logs -f deployment/user-service -n ai-quiz-system
```

---

## 9. å¼€å‘è§„èŒƒ

### 9.1 ä»£ç é£æ ¼

- âœ… TypeScriptä¸¥æ ¼æ¨¡å¼
- âœ… ESLint + Prettier
- âœ… éµå¾ªSOLIDåŸåˆ™
- âœ… å•å…ƒæµ‹è¯•è¦†ç›– > 80%

### 9.2 Gitæäº¤

```bash
feat: æ–°åŠŸèƒ½
fix: Bugä¿®å¤
docs: æ–‡æ¡£æ›´æ–°
style: ä»£ç æ ¼å¼
refactor: é‡æ„
test: æµ‹è¯•
chore: æ„å»º/å·¥å…·
```

### 9.3 æ–‡ä»¶å‘½å

```
Controller:  *.controller.ts
Service:     *.service.ts
Module:      *.module.ts
DTO:         *.dto.ts
Guard:       *.guard.ts
Interceptor: *.interceptor.ts
Decorator:   *.decorator.ts
```

---

## 10. å¸¸è§é—®é¢˜

### Q: å¦‚ä½•æ·»åŠ æ–°çš„APIæ¥å£ï¼Ÿ

1. åœ¨ `presentation/routers/` ä¸­åˆ›å»ºrouter
2. å®šä¹‰Zod schemaéªŒè¯
3. åœ¨ `features/` ä¸­å®ç°Service
4. æ›´æ–° `app.router.ts`

### Q: å¦‚ä½•æ·»åŠ æƒé™æ§åˆ¶ï¼Ÿ

```typescript
@RequirePermissions('resource:action')
async myMethod() {
  // ...
}
```

### Q: å¦‚ä½•è®°å½•å®¡è®¡æ—¥å¿—ï¼Ÿ

```typescript
@Audit({ action: 'CREATE', resource: 'USER' })
async create() {
  // ...
}
```

### Q: å¦‚ä½•ä½¿ç”¨ç¼“å­˜ï¼Ÿ

```typescript
@Cacheable({ key: 'user', ttl: 300 })
async findById(id: string) {
  // ...
}
```

### Q: å¦‚ä½•å¯åŠ¨å•ä¸ªå¾®æœåŠ¡ï¼Ÿ

```bash
npm run start:user-service
# æˆ–
ts-node src/microservices/user-service/main.ts
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

| æ–‡æ¡£ | è¯´æ˜ |
|------|------|
| [å®Œæ•´æ¶æ„è®¾è®¡](./åç«¯æ–‡æ¡£/ARCHITECTURE.md) | è¯¦ç»†çš„ç³»ç»Ÿæ¶æ„ã€æŠ€æœ¯æ ˆ |
| [æ¶æ„å›¾é›†](./åç«¯æ–‡æ¡£/ARCHITECTURE_DIAGRAMS.md) | Mermaidå¯è§†åŒ–æ¶æ„å›¾ |
| [ç›‘æ§æŒ‡å—](./åç«¯æ–‡æ¡£/MONITORING_GUIDE.md) | ç›‘æ§ç³»ç»Ÿå®Œæ•´ä½¿ç”¨æŒ‡å— |
| [å®Œæ•´å¼€å‘æ‰‹å†Œ](./åç«¯æ–‡æ¡£/COMPLETE_GUIDE.md) | 1887è¡Œè¯¦ç»†å¼€å‘è§„èŒƒ |
| [ç»„ä»¶æ¸…å•](./åç«¯æ–‡æ¡£/COMPONENTS_COMPLETED.md) | æ‰€æœ‰å·²å®ç°ç»„ä»¶ |
| [å¾®æœåŠ¡åˆ—è¡¨](./åç«¯æ–‡æ¡£/MICROSERVICES.md) | 9ä¸ªå¾®æœåŠ¡è¯¦ç»†è¯´æ˜ |
| [tRPC Schema](./åç«¯æ–‡æ¡£/SCHEMAS_GUIDE.md) | tRPCè·¯ç”±æ–‡æ¡£ |

---

## ğŸš€ å¿«é€Ÿå‘½ä»¤

```bash
# å¼€å‘
npm run start:dev

# æ„å»º
npm run build

# æµ‹è¯•
npm run test
npm run test:e2e
npm run test:cov

# æ•°æ®åº“
npx prisma generate
npx prisma db push
npx prisma studio

# å¾®æœåŠ¡
npm run start:user-service
npm run start:exam-service

# ç›‘æ§
./scripts/start-monitoring.sh
./scripts/stop-monitoring.sh

# Docker
docker-compose up -d
docker-compose logs -f
docker-compose down
```

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** V2.0  
**æœ€åæ›´æ–°ï¼š** 2025-10-14  
**ç»´æŠ¤å›¢é˜Ÿï¼š** Backend Team  
**å­—æ•°ï¼š** ~8,000å­—  
**é˜…è¯»æ—¶é—´ï¼š** ~30åˆ†é’Ÿ

---

**ğŸ’¡ æç¤ºï¼š** æœ¬æ–‡æ¡£æ˜¯ç²¾ç®€ç‰ˆï¼Œå®Œæ•´è¯¦ç»†å†…å®¹è¯·æŸ¥çœ‹ç›¸å…³æ–‡æ¡£ã€‚


