# 🚀 AI智能题库系统 - 后端完整开发指南

> **版本：** V2.0  
> **更新日期：** 2025-10-14  
> **技术栈：** NestJS 10 + TypeScript + PostgreSQL + gRPC + 微服务

---

## 📖 使用本文档

**本文档是精简的开发指南，如需详细信息请查看：**
- [完整架构设计](./后端文档/ARCHITECTURE.md) - 详细的系统架构
- [架构图集](./后端文档/ARCHITECTURE_DIAGRAMS.md) - Mermaid可视化图
- [监控系统指南](./后端文档/MONITORING_GUIDE.md) - Prometheus + Grafana + ELK
- [完整开发手册](./后端文档/COMPLETE_GUIDE.md) - 1887行详细规范
- [微服务列表](./后端文档/MICROSERVICES.md) - 9个微服务说明

---

## 📑 目录

1. [快速开始](#1-快速开始-5分钟)
2. [项目结构](#2-项目结构)
3. [核心概念](#3-核心概念)
4. [微服务架构](#4-微服务架构)
5. [数据库设计](#5-数据库设计)
6. [API开发](#6-api开发)
7. [监控系统](#7-监控系统)
8. [部署指南](#8-部署指南)
9. [开发规范](#9-开发规范)
10. [常见问题](#10-常见问题)

---

## 1. 快速开始 (5分钟)

### 1.1 环境要求

```bash
Node.js >= 20.x
PostgreSQL >= 16.x
Redis >= 7.x
Docker & Docker Compose (推荐)
```

### 1.2 一键启动

```bash
# 1. 克隆项目
git clone <repository-url>
cd quizmind/packages/server

# 2. 安装依赖
npm install

# 3. 配置环境变量
cp .env.example .env
# 编辑 .env 文件，配置数据库等

# 4. 初始化数据库
npx prisma generate
npx prisma db push
npx ts-node prisma/seed-enterprise.ts

# 5. 启动监控栈（可选但推荐）
chmod +x scripts/*.sh
./scripts/start-monitoring.sh

# 6. 启动开发服务器
npm run start:dev
```

### 1.3 验证安装

```bash
# 访问API
curl http://localhost:3000

# 访问Swagger文档
open http://localhost:3000/api/docs

# 访问健康检查
curl http://localhost:3000/health

# 访问Prometheus指标
curl http://localhost:3000/metrics

# 访问监控面板
open http://localhost:3001    # Grafana (admin/admin)
open http://localhost:9090    # Prometheus
open http://localhost:16686   # Jaeger
open http://localhost:5601    # Kibana
```

---

## 2. 项目结构

```
packages/server/
├── src/
│   ├── core/                      # 核心框架
│   │   ├── config/               # 配置管理
│   │   ├── database/             # 数据库连接
│   │   ├── logging/              # 日志系统
│   │   └── trpc/                 # tRPC配置
│   │
│   ├── infrastructure/           # 基础设施
│   │   ├── prisma/              # Prisma服务
│   │   ├── health/              # 健康检查
│   │   └── metrics/             # 指标收集
│   │
│   ├── features/                 # 业务功能
│   │   ├── auth/                # 认证授权
│   │   └── users/               # 用户管理
│   │
│   ├── enterprise/              # 企业功能
│   │   ├── audit/              # 审计日志
│   │   ├── permissions/        # 权限管理
│   │   ├── email/              # 邮件服务
│   │   ├── upload/             # 文件上传
│   │   └── queue/              # 消息队列
│   │
│   ├── microservices/          # 微服务 ⭐
│   │   ├── user-service/       # (50051) 用户服务
│   │   ├── exam-service/       # (50052) 考试服务
│   │   ├── question-service/   # (50053) 题目服务
│   │   ├── paper-service/      # (50054) 组卷服务
│   │   ├── ai-service/         # (50055) AI服务
│   │   ├── practice-service/   # (50056) 练习服务
│   │   ├── analytics-service/  # (50057) 分析服务
│   │   ├── social-service/     # (50058) 社交服务
│   │   └── document-service/   # (50059) 文档服务
│   │
│   ├── common/                  # 公共组件 ⭐
│   │   ├── monitoring/         # Prometheus监控
│   │   ├── logging/            # Elasticsearch日志
│   │   ├── tracing/            # Jaeger追踪
│   │   ├── config/             # 配置中心
│   │   ├── rate-limit/         # 限流
│   │   ├── load-balancer/      # 负载均衡
│   │   ├── microservices/      # 微服务工具
│   │   └── interceptors/       # 拦截器
│   │
│   ├── presentation/            # 表现层
│   │   └── routers/            # tRPC路由
│   │
│   ├── shared/                  # 共享层
│   │   ├── decorators/         # 装饰器
│   │   ├── guards/             # 守卫
│   │   └── services/           # 共享服务
│   │
│   └── main.ts                  # 应用入口
│
├── proto/                       # gRPC Proto文件
│   ├── user.proto
│   ├── exam.proto
│   └── ... (9个proto文件)
│
├── prisma/                      # 数据库
│   ├── schema.prisma           # Schema定义
│   ├── seed.ts                 # 种子数据
│   └── migrations/             # 迁移文件
│
├── scripts/                     # 脚本
│   ├── start-monitoring.sh     # 启动监控
│   └── stop-monitoring.sh      # 停止监控
│
├── docker-compose.monitoring.yml  # 监控栈配置
├── prometheus.yml              # Prometheus配置
└── package.json
```

---

## 3. 核心概念

### 3.1 技术栈

```typescript
{
  "核心框架": "NestJS 10 + TypeScript 5",
  "数据库": "PostgreSQL 16 + Prisma ORM",
  "缓存": "Redis 7",
  "微服务通信": "gRPC + Protocol Buffers",
  "端到端类型安全": "tRPC",
  "服务治理": "Consul + Opossum",
  "监控": "Prometheus + Grafana",
  "日志": "ELK Stack",
  "追踪": "Jaeger + OpenTelemetry",
  "AI": "DeepSeek + LangChain + Pinecone"
}
```

### 3.2 Spring Boot风格装饰器

NestJS原生支持装饰器，我们扩展了类似Spring Boot的注解：

```typescript
// ===== 缓存 =====
@Cacheable({ key: 'user', ttl: 300 })
async findUserById(id: string) {
  return this.prisma.user.findUnique({ where: { id } });
}

// ===== 事务 =====
@Transactional()
async transferPoints(fromId: string, toId: string, points: number) {
  await this.deductPoints(fromId, points);
  await this.addPoints(toId, points);
}

// ===== 重试 =====
@Retry({ maxAttempts: 3, delay: 1000 })
async callExternalAPI() {
  return axios.get('https://api.example.com');
}

// ===== 定时任务 =====
@Scheduled({ cron: '0 0 2 * * *' })
async dailyCleanup() {
  await this.cleanupOldData();
}

// ===== 限流 =====
@RateLimit({ max: 100, windowMs: 60000 })
@Get('api/search')
async search() {
  return this.searchService.search();
}

// ===== 熔断器 =====
@CircuitBreaker({ threshold: 5, timeout: 3000 })
async callUnstableService() {
  return this.externalService.call();
}

// ===== 权限控制 =====
@RequirePermissions('user:read')
@Get('users')
async findAll() {
  return this.userService.findAll();
}

// ===== 审计日志 =====
@Audit({ action: 'CREATE', resource: 'USER' })
@Post('users')
async create(@Body() dto: CreateUserDto) {
  return this.userService.create(dto);
}
```

### 3.3 模块分类

```
infrastructure/    # 基础设施（与业务无关）
  ├─ prisma       # 数据库服务
  ├─ health       # 健康检查
  ├─ metrics      # 指标收集
  └─ trpc         # tRPC基础

features/         # 业务功能（核心逻辑）
  ├─ auth         # 认证授权
  ├─ users        # 用户管理
  ├─ exams        # 考试管理
  └─ questions    # 题目管理

enterprise/       # 企业功能（增强功能）
  ├─ audit        # 审计日志
  ├─ permissions  # 权限管理
  ├─ email        # 邮件服务
  ├─ upload       # 文件上传
  └─ queue        # 消息队列
```

---

## 4. 微服务架构

### 4.1 服务列表

| 服务 | 端口 | 职责 | 技术 |
|------|------|------|------|
| **API Gateway** | 3000 | 统一入口、路由 | NestJS + tRPC |
| **User Service** | 50051 | 用户、认证、RBAC | gRPC + Prisma |
| **Exam Service** | 50052 | 考试、监考 | gRPC + Prisma |
| **Question Service** | 50053 | 题库、分类 | gRPC + Prisma |
| **Paper Service** | 50054 | 组卷、智能组卷 | gRPC + Prisma |
| **AI Service** | 50055 | AI批改、出题 | gRPC + DeepSeek |
| **Practice Service** | 50056 | 练习、错题本 | gRPC + Prisma |
| **Analytics Service** | 50057 | 数据分析 | gRPC + Prisma |
| **Social Service** | 50058 | 排行榜、PK、讨论 | gRPC + Prisma |
| **Document Service** | 50059 | 文档解析、OCR | gRPC + Tesseract |

### 4.2 创建微服务

#### 步骤1：定义Proto文件

```protobuf
// proto/myservice.proto
syntax = "proto3";
package myservice;

service MyService {
  rpc DoSomething(Request) returns (Response);
}

message Request {
  string id = 1;
}

message Response {
  string result = 1;
}
```

#### 步骤2：创建服务目录

```
src/microservices/myservice/
├── myservice-grpc.controller.ts
├── myservice.service.ts
├── myservice.module.ts
└── main.ts
```

#### 步骤3：实现Controller

```typescript
// myservice-grpc.controller.ts
import { Controller } from '@nestjs/common';
import { GrpcMethod } from '@nestjs/microservices';

@Controller()
export class MyServiceGrpcController {
  constructor(private readonly service: MyService) {}
  
  @GrpcMethod('MyService', 'DoSomething')
  async doSomething(data: { id: string }) {
    return await this.service.doSomething(data.id);
  }
}
```

#### 步骤4：启动服务

```typescript
// main.ts
import { NestFactory } from '@nestjs/core';
import { Transport } from '@nestjs/microservices';
import { MyServiceModule } from './myservice.module';
import { join } from 'path';

async function bootstrap() {
  const app = await NestFactory.createMicroservice(MyServiceModule, {
    transport: Transport.GRPC,
    options: {
      package: 'myservice',
      protoPath: join(__dirname, '../../../proto/myservice.proto'),
      url: '0.0.0.0:50060',
    },
  });
  
  await app.listen();
}
bootstrap();
```

### 4.3 服务间调用

```typescript
// 在API Gateway中调用微服务
@Injectable()
export class GatewayService {
  private userService: UserServiceClient;
  
  constructor() {
    this.userService = ClientProxyFactory.create({
      transport: Transport.GRPC,
      options: {
        package: 'user',
        protoPath: join(__dirname, '../../proto/user.proto'),
        url: 'localhost:50051',
      },
    });
  }
  
  async getUserById(id: string) {
    return this.userService.send('FindUserById', { id }).toPromise();
  }
}
```

### 4.4 服务治理

#### 服务注册（Consul）

```typescript
// common/microservices/service-registry.service.ts
@Injectable()
export class ServiceRegistryService {
  async register(serviceName: string, port: number) {
    await this.consul.agent.service.register({
      id: `${serviceName}-${port}`,
      name: serviceName,
      address: '127.0.0.1',
      port,
      check: {
        http: `http://127.0.0.1:${port}/health`,
        interval: '10s',
      },
    });
  }
}
```

#### 负载均衡

```typescript
// common/load-balancer/load-balancer.service.ts
@Injectable()
export class LoadBalancerService {
  // 6种算法
  selectInstance(
    serviceName: string,
    instances: ServiceInstance[],
    strategy: LoadBalanceStrategy,
  ) {
    switch (strategy) {
      case 'RANDOM': return this.selectRandom(instances);
      case 'ROUND_ROBIN': return this.selectRoundRobin(instances);
      case 'WEIGHTED_ROUND_ROBIN': return this.selectWeightedRoundRobin(instances);
      case 'LEAST_CONNECTIONS': return this.selectLeastConnections(instances);
      case 'CONSISTENT_HASH': return this.selectConsistentHash(key, instances);
      case 'IP_HASH': return this.selectIPHash(ip, instances);
    }
  }
}
```

#### 熔断器（Opossum）

```typescript
// common/microservices/circuit-breaker.service.ts
@Injectable()
export class CircuitBreakerService {
  getBreaker(serviceName: string): CircuitBreaker {
    return new CircuitBreaker(
      async (...args) => this.call(serviceName, ...args),
      {
        timeout: 3000,
        errorThresholdPercentage: 50,
        resetTimeout: 30000,
      }
    );
  }
}
```

---

## 5. 数据库设计

### 5.1 核心原则

**遵循阿里开发规范 - 不使用物理外键**

```prisma
// ✅ 正确的设计
model ExamRecord {
  id       String @id @default(cuid())
  userId   String  // 逻辑外键
  examId   String  // 逻辑外键
  score    Float
  
  // 不定义 @relation
  
  @@index([userId])
  @@index([examId])
  @@map("exam_records")
}
```

### 5.2 应用层验证

```typescript
// Service层验证
async create(dto: CreateExamRecordDto) {
  // 验证并获取用户
  const user = await this.validateAndGetUser(dto.userId);
  
  // 验证并获取考试
  const exam = await this.validateAndGetExam(dto.examId);
  
  // 业务验证
  if (!user.isActive) {
    throw new BadRequestException('用户账号未激活');
  }
  
  return this.prisma.examRecord.create({ data: dto });
}
```

### 5.3 常用操作

```typescript
// 查询
const user = await this.prisma.user.findUnique({
  where: { id },
  select: { id: true, username: true, email: true },
});

// 创建
const user = await this.prisma.user.create({
  data: { username, email, password },
});

// 更新
const user = await this.prisma.user.update({
  where: { id },
  data: { username },
});

// 删除（软删除）
const user = await this.prisma.user.update({
  where: { id },
  data: {
    isActive: false,
    deletedAt: new Date(),
  },
});

// 分页查询
const [users, total] = await Promise.all([
  this.prisma.user.findMany({
    skip: (page - 1) * limit,
    take: limit,
  }),
  this.prisma.user.count(),
]);
```

---

## 6. API开发

### 6.1 tRPC路由

```typescript
// presentation/routers/users.router.ts
import { router, publicProcedure, protectedProcedure } from '../trpc';
import { z } from 'zod';

export const usersRouter = router({
  // 公开接口
  list: publicProcedure
    .input(z.object({
      page: z.number().default(1),
      limit: z.number().default(10),
    }))
    .query(async ({ input }) => {
      return await usersService.findAll(input);
    }),
  
  // 需要认证的接口
  me: protectedProcedure
    .query(async ({ ctx }) => {
      return await usersService.findById(ctx.user.id);
    }),
  
  // 需要权限的接口
  create: protectedProcedure
    .input(z.object({
      username: z.string().min(3),
      email: z.string().email(),
      password: z.string().min(6),
    }))
    .mutation(async ({ input, ctx }) => {
      // 检查权限
      if (!ctx.user.permissions.includes('user:create')) {
        throw new Error('无权限');
      }
      
      return await usersService.create(input);
    }),
});
```

### 6.2 REST API（Swagger）

```typescript
// Controller示例
@Controller('users')
@ApiTags('用户管理')
@UseGuards(JwtAuthGuard, PermissionsGuard)
export class UsersController {
  @Get()
  @ApiOperation({ summary: '获取用户列表' })
  @ApiResponse({ status: 200, description: '成功' })
  @RequirePermissions('user:read')
  async findAll(@Query() query: FindUsersDto) {
    return this.usersService.findAll(query);
  }
  
  @Post()
  @ApiOperation({ summary: '创建用户' })
  @RequirePermissions('user:create')
  @Audit({ action: 'CREATE', resource: 'USER' })
  async create(@Body() dto: CreateUserDto) {
    return this.usersService.create(dto);
  }
}
```

### 6.3 DTO验证

```typescript
// dtos/create-user.dto.ts
import { IsString, IsEmail, MinLength, IsOptional } from 'class-validator';

export class CreateUserDto {
  @IsString()
  @MinLength(3)
  username: string;
  
  @IsEmail()
  email: string;
  
  @IsString()
  @MinLength(6)
  password: string;
  
  @IsOptional()
  @IsString()
  nickname?: string;
}
```

---

## 7. 监控系统

### 7.1 快速启动

```bash
# 启动所有监控服务
./scripts/start-monitoring.sh

# 访问监控面板
open http://localhost:3001    # Grafana
open http://localhost:9090    # Prometheus
open http://localhost:16686   # Jaeger
open http://localhost:5601    # Kibana
```

### 7.2 Prometheus指标

```typescript
// 自动收集指标（使用拦截器）
@Module({
  providers: [
    {
      provide: APP_INTERCEPTOR,
      useClass: MetricsInterceptor,  // 自动收集HTTP指标
    },
  ],
})

// 手动记录指标
this.metricsService.recordHttpRequest(method, path, statusCode, duration);
this.metricsService.recordGrpcCall(service, method, status, duration);
this.metricsService.recordDbQuery(operation, duration);
```

### 7.3 常用查询

```promql
# 请求QPS
rate(http_requests_total[1m])

# 95分位响应时间
histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))

# 错误率
rate(http_requests_total{status_code=~"5.."}[5m]) / rate(http_requests_total[5m])

# CPU使用率
100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)
```

### 7.4 日志查询（Kibana）

```
# 查询错误日志
level: "ERROR" AND service: "user-service"

# 查询特定TraceId
traceId: "abc123def456"

# 查询AI服务调用
type: "ai_request" AND provider: "deepseek"
```

---

## 8. 部署指南

### 8.1 Docker Compose

```bash
# 启动监控栈
docker-compose -f docker-compose.monitoring.yml up -d

# 启动应用
docker-compose up -d

# 查看日志
docker-compose logs -f
```

### 8.2 Kubernetes

```bash
# 部署到K8s
kubectl apply -f k8s/

# 查看Pod
kubectl get pods -n ai-quiz-system

# 查看日志
kubectl logs -f deployment/user-service -n ai-quiz-system
```

---

## 9. 开发规范

### 9.1 代码风格

- ✅ TypeScript严格模式
- ✅ ESLint + Prettier
- ✅ 遵循SOLID原则
- ✅ 单元测试覆盖 > 80%

### 9.2 Git提交

```bash
feat: 新功能
fix: Bug修复
docs: 文档更新
style: 代码格式
refactor: 重构
test: 测试
chore: 构建/工具
```

### 9.3 文件命名

```
Controller:  *.controller.ts
Service:     *.service.ts
Module:      *.module.ts
DTO:         *.dto.ts
Guard:       *.guard.ts
Interceptor: *.interceptor.ts
Decorator:   *.decorator.ts
```

---

## 10. 常见问题

### Q: 如何添加新的API接口？

1. 在 `presentation/routers/` 中创建router
2. 定义Zod schema验证
3. 在 `features/` 中实现Service
4. 更新 `app.router.ts`

### Q: 如何添加权限控制？

```typescript
@RequirePermissions('resource:action')
async myMethod() {
  // ...
}
```

### Q: 如何记录审计日志？

```typescript
@Audit({ action: 'CREATE', resource: 'USER' })
async create() {
  // ...
}
```

### Q: 如何使用缓存？

```typescript
@Cacheable({ key: 'user', ttl: 300 })
async findById(id: string) {
  // ...
}
```

### Q: 如何启动单个微服务？

```bash
npm run start:user-service
# 或
ts-node src/microservices/user-service/main.ts
```

---

## 📚 相关文档

| 文档 | 说明 |
|------|------|
| [完整架构设计](./后端文档/ARCHITECTURE.md) | 详细的系统架构、技术栈 |
| [架构图集](./后端文档/ARCHITECTURE_DIAGRAMS.md) | Mermaid可视化架构图 |
| [监控指南](./后端文档/MONITORING_GUIDE.md) | 监控系统完整使用指南 |
| [完整开发手册](./后端文档/COMPLETE_GUIDE.md) | 1887行详细开发规范 |
| [组件清单](./后端文档/COMPONENTS_COMPLETED.md) | 所有已实现组件 |
| [微服务列表](./后端文档/MICROSERVICES.md) | 9个微服务详细说明 |
| [tRPC Schema](./后端文档/SCHEMAS_GUIDE.md) | tRPC路由文档 |

---

## 🚀 快速命令

```bash
# 开发
npm run start:dev

# 构建
npm run build

# 测试
npm run test
npm run test:e2e
npm run test:cov

# 数据库
npx prisma generate
npx prisma db push
npx prisma studio

# 微服务
npm run start:user-service
npm run start:exam-service

# 监控
./scripts/start-monitoring.sh
./scripts/stop-monitoring.sh

# Docker
docker-compose up -d
docker-compose logs -f
docker-compose down
```

---

**文档版本：** V2.0  
**最后更新：** 2025-10-14  
**维护团队：** Backend Team  
**字数：** ~8,000字  
**阅读时间：** ~30分钟

---

**💡 提示：** 本文档是精简版，完整详细内容请查看相关文档。


