# 📱 移动端完整开发指南

> AI 智能题库 - Expo 移动应用开发指南

## 目录

- [技术栈](#技术栈)
- [快速开始](#快速开始)
- [项目结构](#项目结构)
- [核心功能](#核心功能)
- [开发指南](#开发指南)
- [最佳实践](#最佳实践)
- [常见问题](#常见问题)

---

## 技术栈

### 核心框架
- **Expo** ~54.0.0 - React Native 开发框架
- **Expo Router** ~4.0.0 - 文件系统路由
- **React** 19.1.0 - UI 框架
- **React Native** 0.81.4 - 原生支持
- **TypeScript** 5.9.2 - 类型系统

### 状态管理
- **Redux Toolkit** 2.5.0 - 客户端状态
- **React Query** 5.90.3 - 服务端状态缓存

### API 通信
- **tRPC Client** 10.45.2 - 类型安全 API
- **tRPC React Query** 10.45.2 - React 集成

### 工具库
- **Zod** - Schema 验证
- **Expo Secure Store** - 安全存储
- **AsyncStorage** - 本地存储

---

## 快速开始

### 安装依赖

```bash
# 在项目根目录
pnpm install
```

### 启动开发服务器

```bash
# 方式一：在 mobile 目录
cd packages/mobile
pnpm start

# 方式二：使用 workspace filter
pnpm --filter mobile start
```

### 在不同平台运行

```bash
# iOS 模拟器
pnpm --filter mobile ios

# Android 模拟器  
pnpm --filter mobile android

# Web 浏览器
pnpm --filter mobile web
```

---

## 项目结构

```
packages/mobile/
├── app/                          # 📱 Expo Router 页面
│   ├── _layout.tsx              # 根布局 + Provider + 认证守卫
│   ├── index.tsx                # 应用入口（自动重定向）
│   │
│   ├── auth/                    # 认证模块
│   │   ├── _layout.tsx         # 认证布局
│   │   ├── login.tsx           # 登录页面
│   │   └── register.tsx        # 注册页面
│   │
│   └── (tabs)/                  # Tab 导航（主应用）
│       ├── _layout.tsx         # Tab 布局配置
│       ├── index.tsx           # 首页
│       ├── practice.tsx        # 练习页
│       ├── exams.tsx           # 考试页
│       └── profile.tsx         # 个人中心
│
├── src/                         # 源代码
│   ├── components/             # UI 组件
│   │   └── common/            # 通用组件
│   │       └── Button.tsx     # 按钮组件
│   │
│   ├── constants/             # 常量配置
│   │   └── index.ts          # API_CONFIG, THEME, STORAGE_KEYS
│   │
│   ├── hooks/                # 自定义 Hooks
│   │   └── useAuth.ts       # 认证相关 Hook
│   │
│   ├── services/             # 服务层
│   │   └── trpc.ts          # tRPC 客户端配置
│   │
│   ├── store/                # Redux Store
│   │   ├── index.ts         # Store 配置 + Hooks
│   │   └── slices/          # State Slices
│   │       └── authSlice.ts # 认证状态
│   │
│   ├── types/                # TypeScript 类型
│   │   └── index.ts         # 公共类型定义
│   │
│   └── utils/                # 工具函数
│       ├── storage.ts       # 存储工具
│       ├── validators.ts    # 验证工具
│       └── formatters.ts    # 格式化工具
│
├── assets/                   # 静态资源
│   ├── icon.png
│   ├── splash-icon.png
│   └── adaptive-icon.png
│
├── app.config.js            # Expo 配置（动态）
├── app.json                 # Expo 配置（静态）
├── babel.config.js          # Babel 配置（路径别名）
├── metro.config.js          # Metro Bundler 配置
├── tsconfig.json            # TypeScript 配置
├── package.json             # 依赖管理
└── README.md                # 项目文档
```

---

## 核心功能

### 1. 认证系统

#### 登录流程

```tsx
import { useAuth } from '@hooks/useAuth';

export default function LoginScreen() {
  const { login } = useAuth();
  
  const handleLogin = async () => {
    const result = await login(identifier, password);
    if (result.success) {
      // 自动跳转到主页
      router.replace('/(tabs)');
    }
  };
}
```

#### 认证守卫

```tsx
// app/_layout.tsx
function AuthGuard({ children }) {
  const { isAuthenticated, restoreAuth } = useAuth();
  const segments = useSegments();
  
  useEffect(() => {
    const inAuthGroup = segments[0] === 'auth';
    
    if (!isAuthenticated && !inAuthGroup) {
      router.replace('/auth/login');
    } else if (isAuthenticated && inAuthGroup) {
      router.replace('/(tabs)');
    }
  }, [isAuthenticated, segments]);
  
  return <>{children}</>;
}
```

#### 状态持久化

```tsx
// 使用 Expo Secure Store 存储 Token
import { saveAuthToken, getAuthToken } from '@utils/storage';

// 保存（加密存储）
await saveAuthToken(token);

// 获取
const token = await getAuthToken();

// 恢复登录状态
const { restoreAuth } = useAuth();
await restoreAuth();
```

### 2. 文件系统路由

#### 路由自动生成

```tsx
// 文件: app/practice/quiz.tsx
export default function QuizScreen() {
  return <View>...</View>;
}
// 自动生成路由: /practice/quiz
```

#### 路由导航

```tsx
import { useRouter, Link } from 'expo-router';

// Hook 方式
const router = useRouter();
router.push('/practice/quiz');
router.replace('/auth/login');
router.back();

// Link 组件
<Link href="/practice/quiz">开始练习</Link>
```

#### 路由参数

```tsx
// 传递参数
router.push({
  pathname: '/practice/quiz',
  params: { mode: 'random', categoryId: '123' }
});

// 接收参数
import { useLocalSearchParams } from 'expo-router';

const { mode, categoryId } = useLocalSearchParams<{
  mode: string;
  categoryId: string;
}>();
```

### 3. tRPC 集成

#### 查询数据（useQuery）

```tsx
import { trpc } from '@services/trpc';

export default function QuestionList() {
  const { data, isLoading, error } = trpc.questions.list.useQuery({
    categoryId: '123',
    limit: 20,
  });
  
  // data 是完全类型安全的
  return (
    <View>
      {data?.questions.map(q => (
        <Text key={q.id}>{q.title}</Text>
      ))}
    </View>
  );
}
```

#### 修改数据（useMutation）

```tsx
const { mutate, isLoading } = trpc.auth.login.useMutation({
  onSuccess: (data) => {
    console.log('登录成功', data.user);
  },
  onError: (error) => {
    console.error('登录失败', error.message);
  },
});

// 调用
mutate({ identifier: 'user@example.com', password: '123456' });
```

#### 无限滚动（useInfiniteQuery）

```tsx
const {
  data,
  fetchNextPage,
  hasNextPage,
  isFetchingNextPage,
} = trpc.questions.list.useInfiniteQuery(
  { limit: 20 },
  {
    getNextPageParam: (lastPage) => lastPage.nextCursor,
  }
);
```

### 4. Redux 状态管理

#### 使用 Redux State

```tsx
import { useAppSelector, useAppDispatch } from '@store/index';
import { setUser, logout } from '@store/slices/authSlice';

export default function MyComponent() {
  const dispatch = useAppDispatch();
  const { user, isAuthenticated } = useAppSelector(state => state.auth);
  
  const handleLogout = () => {
    dispatch(logout());
  };
}
```

#### 创建新的 Slice

```tsx
// src/store/slices/themeSlice.ts
import { createSlice, PayloadAction } from '@reduxjs/toolkit';

interface ThemeState {
  mode: 'light' | 'dark' | 'system';
}

const initialState: ThemeState = {
  mode: 'system',
};

const themeSlice = createSlice({
  name: 'theme',
  initialState,
  reducers: {
    setTheme: (state, action: PayloadAction<'light' | 'dark' | 'system'>) => {
      state.mode = action.payload;
    },
  },
});

export const { setTheme } = themeSlice.actions;
export default themeSlice.reducer;
```

### 5. 主题系统

#### 使用主题

```tsx
import { THEME } from '@constants/index';
import { StyleSheet } from 'react-native';

const styles = StyleSheet.create({
  container: {
    backgroundColor: THEME.colors.background,
    padding: THEME.spacing.lg,
    borderRadius: THEME.borderRadius.md,
  },
  title: {
    fontSize: THEME.fontSize.xl,
    color: THEME.colors.text,
  },
});
```

#### 扩展主题

```tsx
// src/constants/index.ts
export const THEME = {
  colors: {
    primary: '#4F46E5',
    secondary: '#06B6D4',
    // ... 添加更多颜色
  },
  spacing: {
    xs: 4, sm: 8, md: 16, lg: 24, xl: 32,
  },
  // ... 添加更多主题属性
};
```

---

## 开发指南

### 创建新页面

#### 1. 创建路由文件

```tsx
// app/practice/result.tsx
import { View, Text, StyleSheet } from 'react-native';
import { useLocalSearchParams } from 'expo-router';
import { THEME } from '@constants/index';

export default function PracticeResultScreen() {
  const { score, total } = useLocalSearchParams<{
    score: string;
    total: string;
  }>();
  
  return (
    <View style={styles.container}>
      <Text style={styles.score}>
        得分: {score}/{total}
      </Text>
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    backgroundColor: THEME.colors.background,
  },
  score: {
    fontSize: THEME.fontSize.xxl,
    fontWeight: 'bold',
    color: THEME.colors.text,
  },
});
```

#### 2. 导航到新页面

```tsx
router.push({
  pathname: '/practice/result',
  params: { score: '85', total: '100' }
});
```

### 创建新组件

#### 1. 创建组件文件

```tsx
// src/components/practice/QuestionCard.tsx
import React from 'react';
import { View, Text, StyleSheet, TouchableOpacity } from 'react-native';
import { THEME } from '@constants/index';

interface QuestionCardProps {
  question: {
    id: string;
    title: string;
    options: string[];
  };
  onSelect: (answer: string) => void;
}

export default function QuestionCard({ question, onSelect }: QuestionCardProps) {
  return (
    <View style={styles.card}>
      <Text style={styles.title}>{question.title}</Text>
      {question.options.map((option, index) => (
        <TouchableOpacity
          key={index}
          style={styles.option}
          onPress={() => onSelect(option)}
        >
          <Text>{option}</Text>
        </TouchableOpacity>
      ))}
    </View>
  );
}

const styles = StyleSheet.create({
  card: {
    backgroundColor: THEME.colors.surface,
    padding: THEME.spacing.lg,
    borderRadius: THEME.borderRadius.lg,
    marginBottom: THEME.spacing.md,
  },
  title: {
    fontSize: THEME.fontSize.lg,
    fontWeight: '600',
    marginBottom: THEME.spacing.md,
  },
  option: {
    padding: THEME.spacing.md,
    backgroundColor: THEME.colors.background,
    borderRadius: THEME.borderRadius.md,
    marginBottom: THEME.spacing.sm,
  },
});
```

#### 2. 使用组件

```tsx
import QuestionCard from '@components/practice/QuestionCard';

<QuestionCard
  question={currentQuestion}
  onSelect={handleSelectAnswer}
/>
```

### 调用后端 API

#### 1. 定义类型（可选，tRPC 自动推导）

```tsx
// src/types/index.ts
export interface Question {
  id: string;
  title: string;
  content: string;
  type: QuestionType;
  options?: string[];
  correctAnswer: string | string[];
}
```

#### 2. 使用 tRPC 查询

```tsx
import { trpc } from '@services/trpc';

export default function QuestionListScreen() {
  const { data, isLoading, error, refetch } = trpc.questions.list.useQuery({
    categoryId: '123',
    page: 1,
    limit: 20,
  });
  
  if (isLoading) return <Text>加载中...</Text>;
  if (error) return <Text>错误: {error.message}</Text>;
  
  return (
    <FlatList
      data={data?.questions}
      renderItem={({ item }) => <QuestionItem question={item} />}
      onRefresh={refetch}
      refreshing={isLoading}
    />
  );
}
```

### 处理表单

#### 1. 表单验证

```tsx
import { isEmail, isValidUsername } from '@utils/validators';
import { Alert } from 'react-native';

const handleSubmit = () => {
  // 验证
  if (!isEmail(email)) {
    Alert.alert('错误', '请输入有效的邮箱');
    return;
  }
  
  if (!isValidUsername(username)) {
    Alert.alert('错误', '用户名必须是4-20位字母、数字或下划线');
    return;
  }
  
  // 提交
  mutate({ username, email, password });
};
```

#### 2. 表单组件示例

```tsx
export default function RegisterForm() {
  const [formData, setFormData] = useState({
    username: '',
    email: '',
    password: '',
  });
  
  const { mutate, isLoading } = trpc.auth.register.useMutation({
    onSuccess: () => {
      Alert.alert('成功', '注册成功！');
      router.replace('/(tabs)');
    },
    onError: (error) => {
      Alert.alert('错误', error.message);
    },
  });
  
  return (
    <View>
      <TextInput
        value={formData.username}
        onChangeText={(text) => 
          setFormData(prev => ({ ...prev, username: text }))
        }
        placeholder="用户名"
      />
      {/* 更多输入框... */}
      <Button
        title="注册"
        onPress={() => mutate(formData)}
        loading={isLoading}
      />
    </View>
  );
}
```

---

## 最佳实践

### 1. 代码组织

#### 按功能模块组织

```
src/components/
├── common/         # 通用组件
├── auth/          # 认证相关
├── practice/      # 练习相关
├── exams/         # 考试相关
└── profile/       # 个人中心相关
```

#### 使用路径别名

```tsx
// ❌ 避免
import Button from '../../../components/common/Button';

// ✅ 推荐
import Button from '@components/common/Button';
import { useAuth } from '@hooks/useAuth';
import { THEME } from '@constants/index';
```

### 2. 性能优化

#### 使用 React.memo

```tsx
import React, { memo } from 'react';

const QuestionCard = memo(({ question, onSelect }) => {
  return (
    // ...
  );
});

export default QuestionCard;
```

#### 使用 useCallback 和 useMemo

```tsx
import { useCallback, useMemo } from 'react';

const handleSelect = useCallback((answer: string) => {
  // 处理选择
}, [/* 依赖项 */]);

const filteredQuestions = useMemo(() => {
  return questions.filter(q => q.category === category);
}, [questions, category]);
```

#### FlatList 优化

```tsx
<FlatList
  data={items}
  renderItem={renderItem}
  keyExtractor={(item) => item.id}
  initialNumToRender={10}
  maxToRenderPerBatch={10}
  windowSize={5}
  removeClippedSubviews={true}
  getItemLayout={(data, index) => ({
    length: ITEM_HEIGHT,
    offset: ITEM_HEIGHT * index,
    index,
  })}
/>
```

### 3. 错误处理

#### 全局错误边界

```tsx
// src/components/common/ErrorBoundary.tsx
import React, { Component, ErrorInfo, ReactNode } from 'react';
import { View, Text, Button } from 'react-native';

interface Props {
  children: ReactNode;
}

interface State {
  hasError: boolean;
  error?: Error;
}

export class ErrorBoundary extends Component<Props, State> {
  state: State = { hasError: false };
  
  static getDerivedStateFromError(error: Error): State {
    return { hasError: true, error };
  }
  
  componentDidCatch(error: Error, errorInfo: ErrorInfo) {
    console.error('Error caught:', error, errorInfo);
  }
  
  render() {
    if (this.state.hasError) {
      return (
        <View>
          <Text>出错了</Text>
          <Button
            title="重试"
            onPress={() => this.setState({ hasError: false })}
          />
        </View>
      );
    }
    
    return this.props.children;
  }
}
```

#### API 错误处理

```tsx
const { data, error } = trpc.questions.list.useQuery(params, {
  retry: 3,
  retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 30000),
  onError: (error) => {
    if (error.data?.code === 'UNAUTHORIZED') {
      router.replace('/auth/login');
    } else {
      Alert.alert('错误', error.message);
    }
  },
});
```

### 4. 类型安全

#### 严格的类型定义

```tsx
// src/types/index.ts
export interface Question {
  id: string;
  title: string;
  type: QuestionType;
  // ... 明确的类型
}

export type QuestionType = 
  | 'single_choice' 
  | 'multiple_choice' 
  | 'true_false';
```

#### 避免使用 any

```tsx
// ❌ 避免
const handleData = (data: any) => { ... };

// ✅ 推荐
const handleData = (data: Question[]) => { ... };
// 或
const handleData = <T extends BaseType>(data: T) => { ... };
```

---

## 常见问题

### 1. Metro bundler 缓存问题

```bash
# 清理缓存重启
npx expo start --clear
```

### 2. 真机调试 API 连接

修改 `app.config.js` 使用局域网 IP：

```js
extra: {
  apiUrl: 'http://192.168.1.100:3000',  // 替换为你的 IP
}
```

### 3. iOS 模拟器启动失败

```bash
# 确保 Xcode Command Line Tools 已安装
xcode-select --install

# 手动打开模拟器
open -a Simulator
```

### 4. TypeScript 类型错误

```bash
# 运行类型检查
pnpm typecheck

# 重启 TS Server (VSCode)
Cmd+Shift+P -> TypeScript: Restart TS Server
```

### 5. 依赖安装问题

```bash
# 清理并重新安装
rm -rf node_modules
pnpm install

# 或使用 legacy peer deps
pnpm install --legacy-peer-deps
```

---

## 相关文档

- 📚 [快速开始指南](./移动端快速开始.md)
- 🔄 [迁移指南](./移动端迁移指南.md)
- 📊 [重构总结](./移动端重构总结.md)

## 外部资源

- [Expo 文档](https://docs.expo.dev/)
- [Expo Router 文档](https://expo.github.io/router/)
- [tRPC 文档](https://trpc.io/)
- [React Query 文档](https://tanstack.com/query/)
- [Redux Toolkit 文档](https://redux-toolkit.js.org/)

---

**最后更新**: 2025-10-16  
**版本**: 1.0.0

